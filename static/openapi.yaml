openapi: 3.0.3
info:
  title: Speculum API
  description: |
    REST API for the Speculum web archive platform.

    Speculum preserves websites and YouTube channels at risk of disappearing,
    creating permanent mirrors for future generations.

    ## Authentication
    Most read endpoints are public. Write operations require authentication.

    ## Rate Limiting
    - General: 200 requests/minute
    - URL Preview: 10 requests/minute
  version: 1.0.0
  contact:
    name: Speculum
    url: https://github.com/stellakamikaze/speculum
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: /api
    description: API base path

tags:
  - name: Sites
    description: Archived websites and YouTube channels
  - name: Search
    description: Full-text search across the archive
  - name: Categories
    description: Site categorization
  - name: Tags
    description: Flexible site tagging and filtering
  - name: Crawls
    description: Active crawl monitoring
  - name: Statistics
    description: Archive statistics
  - name: Wayback
    description: Internet Archive integration
  - name: Export
    description: Data export (requires authentication)
  - name: Ghost
    description: Ghost CMS integration - export and webhooks
  - name: Storage
    description: Storage monitoring and management (admin only)
  - name: Collections
    description: Curated thematic collections of archived sites

paths:
  /sites:
    get:
      tags: [Sites]
      summary: List all archived sites
      description: Returns a list of all sites in the archive with their metadata.
      responses:
        '200':
          description: List of sites
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Site'
              example:
                - id: 1
                  name: "Example Blog"
                  url: "https://example.com"
                  status: "ready"
                  site_type: "website"
                  size_bytes: 15728640
                  created_at: "2024-01-15T10:30:00Z"

  /sites/{site_id}:
    get:
      tags: [Sites]
      summary: Get site details
      description: Returns detailed information about a specific archived site.
      parameters:
        - name: site_id
          in: path
          required: true
          schema:
            type: integer
          description: Site ID
      responses:
        '200':
          description: Site details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Site'
        '404':
          description: Site not found

  /sites/{site_id}/status:
    get:
      tags: [Sites]
      summary: Get site crawl status
      description: Returns the current crawl status for polling during archiving.
      parameters:
        - name: site_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Crawl status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [pending, crawling, ready, error, dead]
                  retry_count:
                    type: integer
                  error_message:
                    type: string
                    nullable: true
              example:
                status: "crawling"
                retry_count: 0
                error_message: null

  /sites/{site_id}/preview-images:
    get:
      tags: [Sites]
      summary: Get preview images from a site
      description: Returns random images from the archived site's mirror.
      parameters:
        - name: site_id
          in: path
          required: true
          schema:
            type: integer
        - name: count
          in: query
          schema:
            type: integer
            default: 6
            maximum: 20
          description: Number of images to return
        - name: min_size
          in: query
          schema:
            type: integer
            default: 10000
          description: Minimum file size in bytes
      responses:
        '200':
          description: List of image URLs
          content:
            application/json:
              schema:
                type: object
                properties:
                  images:
                    type: array
                    items:
                      type: object
                      properties:
                        path:
                          type: string
                        filename:
                          type: string

  /search:
    get:
      tags: [Search]
      summary: Full-text search
      description: Search across all archived sites and videos using SQLite FTS5.
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 2
          description: Search query
        - name: type
          in: query
          schema:
            type: string
            enum: [all, sites, videos]
            default: all
          description: Content type to search
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: Maximum results
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  query:
                    type: string
                  total:
                    type: integer
                  sites:
                    type: array
                    items:
                      $ref: '#/components/schemas/Site'
                  videos:
                    type: array
                    items:
                      $ref: '#/components/schemas/Video'
        '400':
          description: Query too short

  /categories:
    get:
      tags: [Categories]
      summary: List all categories
      description: Returns all categories with site counts.
      responses:
        '200':
          description: List of categories
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'

  /stats:
    get:
      tags: [Statistics]
      summary: Get archive statistics
      description: Returns global statistics about the archive.
      responses:
        '200':
          description: Archive statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_sites:
                    type: integer
                  ready_sites:
                    type: integer
                  total_videos:
                    type: integer
                  total_size:
                    type: integer
                    description: Total archive size in bytes
                  crawling_sites:
                    type: integer
              example:
                total_sites: 150
                ready_sites: 142
                total_videos: 3500
                total_size: 107374182400
                crawling_sites: 2

  /crawls/active:
    get:
      tags: [Crawls]
      summary: Get active crawls
      description: Returns all currently running crawl operations.
      responses:
        '200':
          description: Active crawls
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    site_id:
                      type: integer
                    site_name:
                      type: string
                    status:
                      type: string
                    started_at:
                      type: string
                      format: date-time

  /crawls/{site_id}/progress:
    get:
      tags: [Crawls]
      summary: Get crawl progress
      description: Returns progress information for an active crawl.
      parameters:
        - name: site_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Crawl progress
          content:
            application/json:
              schema:
                type: object
                properties:
                  files_downloaded:
                    type: integer
                  bytes_downloaded:
                    type: integer
                  current_file:
                    type: string
        '404':
          description: No active crawl for this site

  /crawls/{site_id}/log:
    get:
      tags: [Crawls]
      summary: Get crawl log
      description: Returns live log output from an active crawl.
      parameters:
        - name: site_id
          in: path
          required: true
          schema:
            type: integer
        - name: lines
          in: query
          schema:
            type: integer
            default: 50
          description: Number of log lines to return
      responses:
        '200':
          description: Log lines
          content:
            application/json:
              schema:
                type: object
                properties:
                  lines:
                    type: array
                    items:
                      type: string

  /preview-url:
    post:
      tags: [Sites]
      summary: Preview URL before archiving
      description: |
        Fetches metadata from a URL without full archiving.
        Uses AI to generate description if available.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url]
              properties:
                url:
                  type: string
                  format: uri
                use_ai:
                  type: boolean
                  default: true
            example:
              url: "https://example.com"
              use_ai: true
      responses:
        '200':
          description: URL preview data
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                  title:
                    type: string
                  description:
                    type: string
                  status_code:
                    type: integer
                  ai_metadata:
                    type: object
                    nullable: true
        '400':
          description: Invalid URL
        '429':
          description: Rate limit exceeded

  /wayback/{site_id}:
    get:
      tags: [Wayback]
      summary: Get Wayback Machine info
      description: Check if a site has been saved to the Internet Archive.
      parameters:
        - name: site_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Wayback Machine status
          content:
            application/json:
              schema:
                type: object
                properties:
                  available:
                    type: boolean
                  wayback_url:
                    type: string
                    nullable: true
                  timestamp:
                    type: string
                    nullable: true

  /random-media:
    get:
      tags: [Sites]
      summary: Get random media
      description: Returns random images from archived sites for gallery display.
      parameters:
        - name: count
          in: query
          schema:
            type: integer
            default: 12
            maximum: 50
      responses:
        '200':
          description: Random images
          content:
            application/json:
              schema:
                type: object
                properties:
                  images:
                    type: array
                    items:
                      type: object
                      properties:
                        path:
                          type: string
                        filename:
                          type: string
                        site_id:
                          type: integer
                        site_name:
                          type: string

  /ollama/status:
    get:
      tags: [Statistics]
      summary: Check AI service status
      description: Returns the status of the Ollama AI service for metadata generation.
      responses:
        '200':
          description: Ollama status
          content:
            application/json:
              schema:
                type: object
                properties:
                  available:
                    type: boolean
                  model:
                    type: string
                    nullable: true

  /tags:
    get:
      tags: [Tags]
      summary: List all tags
      description: Returns all tags with site counts for filtering.
      responses:
        '200':
          description: List of tags
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Tag'
    post:
      tags: [Tags]
      summary: Create a new tag
      description: Creates a new tag (requires authentication).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  maxLength: 50
                color:
                  type: string
                  pattern: '^#[0-9A-Fa-f]{6}$'
                  default: '#666666'
      responses:
        '200':
          description: Tag created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  tag:
                    $ref: '#/components/schemas/Tag'
        '400':
          description: Invalid input

  /sites/{site_id}/tags:
    post:
      tags: [Tags]
      summary: Add tag to site
      description: Adds an existing tag or creates and adds a new tag to a site.
      parameters:
        - name: site_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  required: [tag_id]
                  properties:
                    tag_id:
                      type: integer
                - type: object
                  required: [name]
                  properties:
                    name:
                      type: string
                    color:
                      type: string
      responses:
        '200':
          description: Tag added to site
        '404':
          description: Site or tag not found

  /sites/{site_id}/tags/{tag_id}:
    delete:
      tags: [Tags]
      summary: Remove tag from site
      description: Removes a tag association from a site.
      parameters:
        - name: site_id
          in: path
          required: true
          schema:
            type: integer
        - name: tag_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Tag removed from site
        '404':
          description: Site or tag not found

  /export/ghost:
    get:
      tags: [Ghost]
      summary: Export all sites to Ghost format
      description: |
        Exports all ready sites in Ghost CMS import format.
        Requires authentication.
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [website, youtube]
          description: Filter by site type
        - name: category_id
          in: query
          schema:
            type: integer
          description: Filter by category ID
      responses:
        '200':
          description: Ghost import JSON file
          content:
            application/json:
              schema:
                type: object
                properties:
                  db:
                    type: array
                    items:
                      type: object
                      properties:
                        meta:
                          type: object
                        data:
                          type: object
                          properties:
                            posts:
                              type: array
                            tags:
                              type: array
        '401':
          description: Authentication required

  /export/ghost/{site_id}:
    get:
      tags: [Ghost]
      summary: Export single site to Ghost format
      description: |
        Exports a single site as Ghost CMS post.
        Requires authentication.
      parameters:
        - name: site_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Ghost import JSON for single site
        '404':
          description: Site not found

  /ghost/status:
    get:
      tags: [Ghost]
      summary: Check Ghost integration status
      description: Returns the status of Ghost CMS integration configuration.
      responses:
        '200':
          description: Ghost status
          content:
            application/json:
              schema:
                type: object
                properties:
                  webhook_configured:
                    type: boolean
                  oembed_available:
                    type: boolean
                  export_endpoint:
                    type: string
                    format: uri

  /ghost/webhook:
    post:
      tags: [Ghost]
      summary: Ghost webhook endpoint
      description: |
        Receives webhooks from Ghost CMS.
        Requires GHOST_WEBHOOK_SECRET env var to be configured.
        Ghost sends signature in X-Ghost-Signature header.
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                  description: Event type (post.published, site.changed, etc.)
                post:
                  type: object
                  description: Post data (for post events)
      responses:
        '200':
          description: Webhook processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  event:
                    type: string
        '401':
          description: Invalid signature
        '501':
          description: Webhook not configured

  /storage:
    get:
      tags: [Storage]
      summary: Get complete storage summary
      description: Returns disk usage, per-site sizes, and alerts. Admin only.
      responses:
        '200':
          description: Storage summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  disk:
                    $ref: '#/components/schemas/DiskUsage'
                  sites:
                    type: array
                    items:
                      $ref: '#/components/schemas/SiteStorage'
                  alerts:
                    type: array
                    items:
                      $ref: '#/components/schemas/StorageAlert'
                  summary:
                    type: object
        '403':
          description: Admin access required

  /storage/disk:
    get:
      tags: [Storage]
      summary: Get disk usage only
      description: Returns disk space usage for the mirrors volume.
      responses:
        '200':
          description: Disk usage stats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiskUsage'

  /storage/alerts:
    get:
      tags: [Storage]
      summary: Get storage alerts
      description: Returns active storage alerts based on thresholds.
      responses:
        '200':
          description: List of active alerts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StorageAlert'

  /collections:
    get:
      tags: [Collections]
      summary: List public collections
      description: Returns all public curated collections of archived sites.
      responses:
        '200':
          description: List of collections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Collection'

  /collections/{id}:
    get:
      tags: [Collections]
      summary: Get collection details
      description: Returns a collection with all its sites.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Collection with sites
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CollectionWithSites'
        '404':
          description: Collection not found

  /collections/{id}/sites:
    post:
      tags: [Collections]
      summary: Add site to collection
      description: Adds a site to an existing collection. Requires admin authentication.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [site_id]
              properties:
                site_id:
                  type: integer
      responses:
        '200':
          description: Site added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  site_count:
                    type: integer

  /collections/{id}/sites/{site_id}:
    delete:
      tags: [Collections]
      summary: Remove site from collection
      description: Removes a site from a collection. Requires admin authentication.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: site_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Site removed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  site_count:
                    type: integer

components:
  schemas:
    Site:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        url:
          type: string
          format: uri
        description:
          type: string
          nullable: true
        status:
          type: string
          enum: [pending, crawling, ready, error, retry_pending, dead]
        site_type:
          type: string
          enum: [website, youtube]
        crawl_method:
          type: string
          enum: [wget, singlefile, ytdlp]
        size_bytes:
          type: integer
          nullable: true
        category_id:
          type: integer
          nullable: true
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        last_crawl:
          type: string
          format: date-time
          nullable: true

    Video:
      type: object
      properties:
        id:
          type: integer
        site_id:
          type: integer
        video_id:
          type: string
        title:
          type: string
        description:
          type: string
          nullable: true
        duration:
          type: integer
          nullable: true
        upload_date:
          type: string
          nullable: true
        thumbnail_path:
          type: string
          nullable: true
        file_path:
          type: string
          nullable: true

    Category:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        site_count:
          type: integer

    Tag:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        color:
          type: string
          description: Hex color code for UI display
        site_count:
          type: integer

    DiskUsage:
      type: object
      properties:
        total_bytes:
          type: integer
        used_bytes:
          type: integer
        free_bytes:
          type: integer
        used_percent:
          type: number
        free_percent:
          type: number
        total_human:
          type: string
        used_human:
          type: string
        free_human:
          type: string
        path:
          type: string

    SiteStorage:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        actual_size:
          type: integer
        size_human:
          type: string
        file_count:
          type: integer
        size_mismatch:
          type: boolean

    StorageAlert:
      type: object
      properties:
        level:
          type: string
          enum: [warning, critical, error]
        message:
          type: string
        timestamp:
          type: string
          format: date-time
        threshold:
          type: integer

    Collection:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        cover_image:
          type: string
          format: uri
        is_featured:
          type: boolean
        is_public:
          type: boolean
        curator_name:
          type: string
        curator_bio:
          type: string
        site_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CollectionWithSites:
      allOf:
        - $ref: '#/components/schemas/Collection'
        - type: object
          properties:
            sites:
              type: array
              items:
                $ref: '#/components/schemas/Site'
