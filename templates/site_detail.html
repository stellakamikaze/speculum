{% extends "base.html" %}

{% block title %}{{ site.name }} — Speculum{% endblock %}

{% block meta_description %}{{ site.description[:160] if site.description else 'Archived ' + ('YouTube channel' if site.site_type == 'youtube' else 'website') + ': ' + site.name }}{% endblock %}

{% block og_type %}{% if site.site_type == 'youtube' %}video.other{% else %}website{% endif %}{% endblock %}

{% block og_image %}{% if site.screenshot_path %}{{ url_for('serve_screenshot', site_id=site.id, _external=True) }}{% else %}{{ url_for('static', filename='img/og-default.png', _external=True) }}{% endif %}{% endblock %}

{% block json_ld %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "{% if site.site_type == 'youtube' %}VideoObject{% else %}WebPage{% endif %}",
    "name": "{{ site.name }}",
    "description": "{{ site.description|e if site.description else '' }}",
    "url": "{{ request.url }}",
    {% if site.screenshot_path %}"thumbnailUrl": "{{ url_for('serve_screenshot', site_id=site.id, _external=True) }}",{% endif %}
    "dateModified": "{{ site.updated_at.isoformat() if site.updated_at else site.created_at.isoformat() }}",
    "isPartOf": {
        "@type": "WebSite",
        "name": "Speculum",
        "url": "{{ request.url_root }}"
    }
}
</script>
{% endblock %}

{% block oembed_discovery %}
<link rel="alternate" type="application/json+oembed"
      href="{{ url_for('oembed_endpoint', url=request.url, _external=True) }}"
      title="{{ site.name }}">
{% endblock %}

{% block content %}
<header class="page-header swiss-diagonal">
    <span class="section-label">Dettaglio Sito</span>
    <div class="header-row">
        <div>
            <h1>{{ site.name }}</h1>
            <p class="header-subtitle">
                {% if site.site_type == 'youtube' %}
                <span class="type-badge youtube">YouTube</span>
                {% else %}
                <span class="type-badge website">Sito web</span>
                {% endif %}
                <a href="{{ site.url }}" target="_blank" rel="noopener">{{ site.url }}</a>
            </p>
        </div>
        <span class="status-badge status-{{ site.status }} large">{{ site.status }}</span>
    </div>
</header>

<div class="detail-grid">
    <section class="detail-panel main-panel">
        <h2>Informazioni</h2>
        
        {% if site.description %}
        <p class="site-description-full">{{ site.description }}</p>
        {% endif %}
        
        {% if site.ai_generated %}
        <p class="ai-badge">Metadati generati da IA</p>
        {% endif %}
        
        <dl class="detail-list">
            <dt>Categoria</dt>
            <dd>{{ site.category.name if site.category else 'Nessuna' }}</dd>
            
            <dt>Stato</dt>
            <dd>
                <span class="status-badge status-{{ site.status }}">
                    {% if site.status == 'retry_pending' %}In attesa retry
                    {% elif site.status == 'dead' %}Irraggiungibile
                    {% else %}{{ site.status }}{% endif %}
                </span>
                {% if site.retry_count and site.retry_count > 0 %}
                <span class="retry-count">(tentativi: {{ site.retry_count }}/3)</span>
                {% endif %}
                {% if site.error_message %}
                <span class="error-message">{{ site.error_message }}</span>
                {% endif %}
            </dd>
            
            <dt>Ultimo crawl</dt>
            <dd>{{ site.last_crawl.strftime('%d/%m/%Y alle %H:%M') if site.last_crawl else 'Mai eseguito' }}</dd>
            
            <dt>Prossimo crawl</dt>
            <dd>{{ site.next_crawl.strftime('%d/%m/%Y') if site.next_crawl else 'Non programmato' }}</dd>
            
            <dt>Intervallo aggiornamento</dt>
            <dd>Ogni {{ site.crawl_interval_days }} giorni</dd>
            
            {% if site.site_type == 'website' %}
            <dt>Profondità crawl</dt>
            <dd>{{ 'Illimitata' if site.depth == 0 else site.depth ~ ' livelli' }}</dd>
            
            <dt>Risorse esterne</dt>
            <dd>{{ 'Sì' if site.include_external else 'No' }}</dd>
            {% endif %}
            
            {% if site.status == 'ready' %}
            <dt>{% if site.site_type == 'youtube' %}Video scaricati{% else %}Pagine scaricate{% endif %}</dt>
            <dd>{{ site.page_count }}</dd>

            <dt>Dimensione totale</dt>
            <dd>{{ site._human_size(site.size_bytes) }}</dd>
            {% endif %}

            <dt>Internet Archive</dt>
            <dd>
                {% if site.wayback_status == 'success' and site.wayback_url %}
                <a href="{{ site.wayback_url }}" target="_blank" class="wayback-link">
                    <span class="wayback-badge wayback-success">Archiviato</span>
                </a>
                {% elif site.wayback_status == 'pending' %}
                <span class="wayback-badge wayback-pending">In attesa...</span>
                {% elif site.wayback_status == 'failed' %}
                <span class="wayback-badge wayback-failed">Fallito</span>
                {% else %}
                <span class="wayback-badge wayback-none">Non salvato</span>
                {% endif %}
                {% if site.wayback_saved_at %}
                <small>({{ site.wayback_saved_at.strftime('%d/%m/%Y') }})</small>
                {% endif %}
            </dd>
        </dl>
        
        <div class="panel-actions">
            {% if site.status == 'ready' %}
                {% if site.site_type == 'youtube' %}
                <a href="{{ url_for('channel_videos', site_id=site.id) }}" class="btn btn-primary">Sfoglia video</a>
                {% else %}
                <a href="{{ url_for('serve_mirror', site_path=site._get_mirror_path() + '/') }}" class="btn btn-primary" target="_blank">Visita mirror</a>
                {% endif %}
            {% endif %}
            
            {% if site.status == 'crawling' %}
            <form method="POST" action="{{ url_for('stop_site_crawl', site_id=site.id) }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Interrompere il crawl?')">Stop</button>
            </form>
            <button onclick="showSiteLog()" class="btn btn-secondary">Log live</button>
            {% elif site.status in ('error', 'dead', 'retry_pending') %}
            <form method="POST" action="{{ url_for('retry_site_crawl', site_id=site.id) }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-primary">Riprova</button>
            </form>
            <form method="POST" action="{{ url_for('trigger_crawl', site_id=site.id) }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-secondary">Forza crawl</button>
            </form>
            {% else %}
            <form method="POST" action="{{ url_for('trigger_crawl', site_id=site.id) }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-secondary">
                    {% if site.status == 'ready' %}Aggiorna ora{% else %}Avvia crawl{% endif %}
                </button>
            </form>
            {% endif %}

            {% if site.status == 'ready' and site.site_type == 'website' %}
            <form method="POST" action="{{ url_for('generate_site_metadata', site_id=site.id) }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-secondary" title="Genera nome, descrizione e categoria con AI">
                    {% if site.ai_generated %}Rigenera AI{% else %}Genera AI{% endif %}
                </button>
            </form>
            <form method="POST" action="{{ url_for('fetch_wayback_screenshot', site_id=site.id) }}" style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-secondary" title="Recupera screenshot da Wayback Machine">
                    Screenshot Wayback
                </button>
            </form>
            <a href="{{ url_for('site_media_gallery', site_id=site.id) }}" class="btn btn-secondary" title="Visualizza i media archiviati">
                Galleria media
            </a>
            {% endif %}
        </div>
    </section>

    {% if site.screenshot_path %}
    <section class="detail-panel">
        <h2>Screenshot</h2>
        <a href="{{ url_for('serve_screenshot', site_id=site.id) }}" target="_blank">
            <img src="{{ url_for('serve_screenshot', site_id=site.id) }}" alt="Screenshot" class="site-screenshot">
        </a>
        <p class="screenshot-date">Catturato: {{ site.screenshot_date.strftime('%d/%m/%Y %H:%M') if site.screenshot_date else 'N/D' }}</p>
    </section>
    {% endif %}

    <!-- Log live modal -->
    <div id="site-log-modal" class="modal" style="display:none">
        <div class="modal-content log-modal">
            <div class="modal-header">
                <h3>Log in tempo reale — {{ site.name }}</h3>
                <button onclick="closeSiteLog()" class="btn-close">&times;</button>
            </div>
            <pre class="log-output" id="site-log-output">Caricamento...</pre>
            <div class="modal-footer">
                <label><input type="checkbox" id="site-auto-scroll" checked> Auto-scroll</label>
                <button onclick="closeSiteLog()" class="btn btn-secondary">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
    let siteLogInterval = null;

    function showSiteLog() {
        document.getElementById('site-log-modal').style.display = 'flex';
        updateSiteLog();
        siteLogInterval = setInterval(updateSiteLog, 1000);
    }

    function closeSiteLog() {
        document.getElementById('site-log-modal').style.display = 'none';
        if (siteLogInterval) {
            clearInterval(siteLogInterval);
            siteLogInterval = null;
        }
    }

    function updateSiteLog() {
        fetch('/api/crawls/{{ site.id }}/log?lines=100')
            .then(r => r.json())
            .then(data => {
                if (data.lines) {
                    const output = document.getElementById('site-log-output');
                    output.textContent = data.lines.join('\n');
                    if (document.getElementById('site-auto-scroll').checked) {
                        output.scrollTop = output.scrollHeight;
                    }
                }
            })
            .catch(() => {});
    }

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeSiteLog();
    });
    </script>
    
    {% if site.site_type == 'youtube' and videos %}
    <section class="detail-panel videos-preview">
        <h2>Video recenti</h2>
        <div class="videos-mini-grid">
            {% for video in videos[:6] %}
            <a href="{{ url_for('watch_video', video_id=video.id) }}" class="video-mini">
                {% if video.thumbnail_filename %}
                <img src="{{ url_for('serve_video', site_id=site.id, video_id=video.video_id, filename=video.thumbnail_filename) }}" alt="{{ video.title }}">
                {% else %}
                <div class="thumb-placeholder"></div>
                {% endif %}
                <span class="video-mini-title">{{ video.title[:50] }}{% if video.title|length > 50 %}...{% endif %}</span>
            </a>
            {% endfor %}
        </div>
        {% if videos|length > 6 %}
        <a href="{{ url_for('channel_videos', site_id=site.id) }}" class="btn btn-secondary btn-full">Vedi tutti i {{ videos|length }} video</a>
        {% endif %}
    </section>
    {% endif %}
    
    <section class="detail-panel">
        <h2>Modifica</h2>
        <form method="POST" action="{{ url_for('update_site', site_id=site.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label for="name">Nome</label>
                <input type="text" id="name" name="name" value="{{ site.name }}" class="form-input">
            </div>
            
            <div class="form-group">
                <label for="description">Descrizione</label>
                <textarea id="description" name="description" rows="2" class="form-input">{{ site.description or '' }}</textarea>
            </div>
            
            <div class="form-group">
                <label for="category_id">Categoria</label>
                <select id="category_id" name="category_id" class="form-input">
                    <option value="">— Nessuna —</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if site.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="crawl_interval">Aggiornamento (giorni)</label>
                <input type="number" id="crawl_interval" name="crawl_interval" value="{{ site.crawl_interval_days }}" min="1" class="form-input">
            </div>
            
            {% if site.site_type == 'website' %}
            <div class="form-group">
                <label for="crawl_method">Metodo crawl</label>
                <select id="crawl_method" name="crawl_method" class="form-input">
                    <option value="wget" {% if site.crawl_method == 'wget' %}selected{% endif %}>wget (siti statici)</option>
                    <option value="singlefile" {% if site.crawl_method == 'singlefile' %}selected{% endif %}>SingleFile (JavaScript/SPA)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="depth">Profondità</label>
                <input type="number" id="depth" name="depth" value="{{ site.depth }}" min="0" class="form-input">
                <span class="form-hint">0 = illimitata (solo wget)</span>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="include_external" {% if site.include_external %}checked{% endif %}>
                    <span>Scarica risorse esterne</span>
                </label>
            </div>
            {% endif %}
            
            <button type="submit" class="btn btn-secondary">Salva modifiche</button>
        </form>
    </section>

    <!-- Metadati Culturali -->
    <section class="detail-panel cultural-metadata-section">
        <h2>Metadati Culturali</h2>
        <p class="section-description">Metadati Dublin Core e informazioni per l'archiviazione culturale (Progetto Celeste)</p>

        {% if site.cultural_metadata %}
        <div class="metadata-display">
            <dl class="detail-list">
                {% if site.cultural_metadata.dc_title %}
                <dt>Titolo originale</dt>
                <dd>{{ site.cultural_metadata.dc_title }}</dd>
                {% endif %}
                {% if site.cultural_metadata.dc_creator %}
                <dt>Autore/Organizzazione</dt>
                <dd>{{ site.cultural_metadata.dc_creator }}</dd>
                {% endif %}
                {% if site.cultural_metadata.dc_date %}
                <dt>Data</dt>
                <dd>{{ site.cultural_metadata.dc_date }}</dd>
                {% endif %}
                {% if site.cultural_metadata.historical_period %}
                <dt>Periodo storico</dt>
                <dd>{{ site.cultural_metadata.historical_period }}</dd>
                {% endif %}
                {% if site.cultural_metadata.cultural_movement %}
                <dt>Movimento culturale</dt>
                <dd>{{ site.cultural_metadata.cultural_movement }}</dd>
                {% endif %}
                {% if site.cultural_metadata.original_format %}
                <dt>Formato originale</dt>
                <dd>{{ site.cultural_metadata.original_format }}</dd>
                {% endif %}
                {% if site.cultural_metadata.provenance %}
                <dt>Provenienza</dt>
                <dd>{{ site.cultural_metadata.provenance }}</dd>
                {% endif %}
                {% if site.cultural_metadata.dc_rights %}
                <dt>Licenza/Diritti</dt>
                <dd>{{ site.cultural_metadata.dc_rights }}</dd>
                {% endif %}
                {% if site.cultural_metadata.risk_level %}
                <dt>Rischio scomparsa</dt>
                <dd>
                    <span class="risk-badge risk-{{ site.cultural_metadata.risk_level }}">
                        {% if site.cultural_metadata.risk_level == 'high' %}Alto
                        {% elif site.cultural_metadata.risk_level == 'medium' %}Medio
                        {% else %}Basso{% endif %}
                    </span>
                    {% if site.cultural_metadata.risk_notes %}
                    <span class="risk-notes">{{ site.cultural_metadata.risk_notes }}</span>
                    {% endif %}
                </dd>
                {% endif %}
            </dl>
        </div>
        {% endif %}

        <details class="metadata-form-toggle">
            <summary>{% if site.cultural_metadata %}Modifica metadati{% else %}Aggiungi metadati{% endif %}</summary>

            <form method="POST" action="{{ url_for('update_cultural_metadata_form', site_id=site.id) }}" class="metadata-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <fieldset>
                    <legend>Dublin Core</legend>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dc_title">Titolo originale</label>
                            <input type="text" id="dc_title" name="dc_title" value="{{ site.cultural_metadata.dc_title if site.cultural_metadata else '' }}" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="dc_creator">Autore/Organizzazione</label>
                            <input type="text" id="dc_creator" name="dc_creator" value="{{ site.cultural_metadata.dc_creator if site.cultural_metadata else '' }}" class="form-input">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dc_date">Data (es. "1985", "anni 80")</label>
                            <input type="text" id="dc_date" name="dc_date" value="{{ site.cultural_metadata.dc_date if site.cultural_metadata else '' }}" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="dc_type">Tipo</label>
                            <select id="dc_type" name="dc_type" class="form-input">
                                <option value="">— Seleziona —</option>
                                {% set current_type = site.cultural_metadata.dc_type if site.cultural_metadata else '' %}
                                <option value="website" {% if current_type == 'website' %}selected{% endif %}>Sito web</option>
                                <option value="blog" {% if current_type == 'blog' %}selected{% endif %}>Blog</option>
                                <option value="forum" {% if current_type == 'forum' %}selected{% endif %}>Forum</option>
                                <option value="zine" {% if current_type == 'zine' %}selected{% endif %}>Zine</option>
                                <option value="video" {% if current_type == 'video' %}selected{% endif %}>Video</option>
                                <option value="bbs" {% if current_type == 'bbs' %}selected{% endif %}>BBS</option>
                                <option value="archive" {% if current_type == 'archive' %}selected{% endif %}>Archivio</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="dc_description">Descrizione estesa</label>
                        <textarea id="dc_description" name="dc_description" rows="3" class="form-input">{{ site.cultural_metadata.dc_description if site.cultural_metadata else '' }}</textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dc_subject">Keywords (separate da virgola)</label>
                            <input type="text" id="dc_subject" name="dc_subject" value="{{ site.cultural_metadata.dc_subject if site.cultural_metadata else '' }}" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="dc_language">Lingua</label>
                            <input type="text" id="dc_language" name="dc_language" value="{{ site.cultural_metadata.dc_language if site.cultural_metadata else 'it' }}" class="form-input" placeholder="it">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dc_rights">Licenza/Diritti</label>
                            <input type="text" id="dc_rights" name="dc_rights" value="{{ site.cultural_metadata.dc_rights if site.cultural_metadata else '' }}" class="form-input" placeholder="es. Pubblico dominio, Fair use">
                        </div>
                        <div class="form-group">
                            <label for="dc_source">Fonte originale</label>
                            <input type="text" id="dc_source" name="dc_source" value="{{ site.cultural_metadata.dc_source if site.cultural_metadata else '' }}" class="form-input" placeholder="es. Archive.org, altra collezione">
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Estensioni Celeste</legend>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="historical_period">Periodo storico</label>
                            <select id="historical_period" name="historical_period" class="form-input">
                                <option value="">— Seleziona —</option>
                                {% set current_period = site.cultural_metadata.historical_period if site.cultural_metadata else '' %}
                                <option value="pre-internet" {% if current_period == 'pre-internet' %}selected{% endif %}>Pre-internet</option>
                                <option value="anni 80" {% if current_period == 'anni 80' %}selected{% endif %}>Anni '80</option>
                                <option value="anni 90" {% if current_period == 'anni 90' %}selected{% endif %}>Anni '90</option>
                                <option value="2000-2010" {% if current_period == '2000-2010' %}selected{% endif %}>2000-2010</option>
                                <option value="2010-2020" {% if current_period == '2010-2020' %}selected{% endif %}>2010-2020</option>
                                <option value="post-2020" {% if current_period == 'post-2020' %}selected{% endif %}>Post 2020</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cultural_movement">Movimento culturale</label>
                            <input type="text" id="cultural_movement" name="cultural_movement" value="{{ site.cultural_metadata.cultural_movement if site.cultural_metadata else '' }}" class="form-input" placeholder="es. cyberpunk, autonomia, punk">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="original_format">Formato originale</label>
                            <input type="text" id="original_format" name="original_format" value="{{ site.cultural_metadata.original_format if site.cultural_metadata else '' }}" class="form-input" placeholder="es. VHS, BBS, zine cartacea">
                        </div>
                        <div class="form-group">
                            <label for="provenance">Provenienza</label>
                            <input type="text" id="provenance" name="provenance" value="{{ site.cultural_metadata.provenance if site.cultural_metadata else '' }}" class="form-input" placeholder="es. Archivio Primo Moroni">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="risk_level">Rischio scomparsa</label>
                            <select id="risk_level" name="risk_level" class="form-input">
                                <option value="">— Seleziona —</option>
                                {% set current_risk = site.cultural_metadata.risk_level if site.cultural_metadata else '' %}
                                <option value="high" {% if current_risk == 'high' %}selected{% endif %}>Alto</option>
                                <option value="medium" {% if current_risk == 'medium' %}selected{% endif %}>Medio</option>
                                <option value="low" {% if current_risk == 'low' %}selected{% endif %}>Basso</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="risk_notes">Note sul rischio</label>
                        <textarea id="risk_notes" name="risk_notes" rows="2" class="form-input" placeholder="Perche questo contenuto rischia di scomparire?">{{ site.cultural_metadata.risk_notes if site.cultural_metadata else '' }}</textarea>
                    </div>
                </fieldset>

                <button type="submit" class="btn btn-primary">Salva metadati culturali</button>
            </form>
        </details>
    </section>

    <section class="detail-panel">
        <h2>Cronologia crawl</h2>
        {% if logs %}
        <ul class="log-list">
            {% for log in logs %}
            <li class="log-item log-{{ log.status }}">
                <span class="log-date">{{ log.started_at.strftime('%d/%m/%Y %H:%M') }}</span>
                <span class="log-status">{{ log.status }}</span>
                {% if log.status == 'success' %}
                <span class="log-meta">{{ log.pages_crawled }} {% if site.site_type == 'youtube' %}video{% else %}pagine{% endif %}</span>
                {% elif log.error_message %}
                <span class="log-error">{{ log.error_message[:100] }}</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-text">Nessun crawl eseguito</p>
        {% endif %}
    </section>
    
    <section class="detail-panel danger-zone">
        <h2>Zona pericolosa</h2>

        {% if site.status == 'ready' %}
        <div class="danger-action">
            <p>Elimina i file scaricati ma mantieni la voce nel database. Potrai rifare il crawl in seguito.</p>
            <form method="POST" action="{{ url_for('clear_site_files', site_id=site.id) }}" onsubmit="return confirm('Eliminare tutti i file scaricati?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-warning">Elimina file</button>
            </form>
        </div>
        {% endif %}

        <div class="danger-action">
            <p>Elimina questo sito e tutti i file scaricati. Questa azione è irreversibile.</p>
            <form method="POST" action="{{ url_for('delete_site', site_id=site.id) }}" onsubmit="return confirm('Sei sicuro di voler eliminare questo sito e tutto il suo mirror?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-danger">Elimina sito</button>
            </form>
        </div>
    </section>
</div>

{% endblock %}

{% block scripts %}
{% if site.status == 'crawling' %}
<script>
setInterval(function() {
    fetch('/api/sites/{{ site.id }}/status')
        .then(r => r.json())
        .then(data => {
            if (data.status !== 'crawling') {
                location.reload();
            }
        });
}, 5000);
</script>
{% endif %}
{% endblock %}
