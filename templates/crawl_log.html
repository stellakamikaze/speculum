{% extends "base.html" %}

{% block title %}Log Crawl — {{ site.name }} — Speculum{% endblock %}

{% block content %}
<header class="page-header swiss-diagonal">
    <span class="section-label">Diagnostica</span>
    <div class="header-row">
        <div>
            <h1>Log<br>Crawl</h1>
            <p class="header-subtitle">{{ site.name }} — {{ log.started_at.strftime('%d/%m/%Y %H:%M') }}</p>
        </div>
        <a href="{{ url_for('site_detail', site_id=site.id) }}" class="btn btn-secondary">Torna al sito</a>
    </div>
</header>

<div class="log-details">
    <div class="detail-grid">
        <div class="detail-panel">
            <h2>Informazioni</h2>
            <dl class="detail-list">
                <dt>Stato</dt>
                <dd><span class="status-badge status-{{ log.status }}">{{ log.status }}</span></dd>

                <dt>Inizio</dt>
                <dd>{{ log.started_at.strftime('%d/%m/%Y %H:%M:%S') }}</dd>

                <dt>Fine</dt>
                <dd>{{ log.finished_at.strftime('%d/%m/%Y %H:%M:%S') if log.finished_at else 'In corso...' }}</dd>

                {% if log.finished_at %}
                <dt>Durata</dt>
                <dd>{{ ((log.finished_at - log.started_at).total_seconds() / 60)|round(1) }} minuti</dd>
                {% endif %}

                <dt>Pagine</dt>
                <dd>{{ log.pages_crawled or 0 }}</dd>

                <dt>Dimensione</dt>
                <dd>{{ site._human_size(log.size_bytes) }}</dd>

                {% if log.error_message %}
                <dt>Errore</dt>
                <dd class="error-text">{{ log.error_message }}</dd>
                {% endif %}
            </dl>
        </div>
    </div>

    {% if log.wget_log %}
    <section class="log-section">
        <h2>Output wget</h2>
        <pre class="log-output full-log">{{ log.wget_log }}</pre>
    </section>
    {% else %}
    <section class="log-section">
        <p class="empty-text">Nessun log disponibile per questo crawl.</p>
    </section>
    {% endif %}
</div>

<div class="page-actions">
    <a href="{{ url_for('site_detail', site_id=site.id) }}" class="btn btn-secondary">Torna al sito</a>
    {% if site.status in ('error', 'dead') %}
    <form method="POST" action="{{ url_for('retry_site_crawl', site_id=site.id) }}" style="display:inline">
        <button type="submit" class="btn btn-primary">Riprova crawl</button>
    </form>
    {% endif %}
</div>
{% endblock %}
